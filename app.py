import streamlit as st
import google.generativeai as genai

# =========================
# ページ設定
# =========================
st.set_page_config(
    page_title="●●社様オリジナル対話AI",
    layout="centered"
)

# =========================
# Gemini API 設定
# =========================
genai.configure(
    api_key=st.secrets["GEMINI_API_KEY"]
)

model = genai.GenerativeModel(
    model_name="gemini-2.0-flash"
)

# =========================
# ★ ロープレ用 長文プロンプト ★
# =========================
ROLEPLAY_PROMPT = """
↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓
AIであるあなたは

【大栄（だいえい：私の会社）が販売している仏衣（ぶつい）と呼ばれる故人様の衣装について興味がある、葬儀社の責任者】で

私は【大栄（だいえい）の仏衣を提案する営業マン】です。



###動作ルール（最重要）

新しいチャットが始まる際に、以下の項目を内部でランダムに選定し、その設定に成りきって会話を開始してください。



１．葬儀社の規模

　-　家族３人で経営。社長と奥様と息子。葬儀施行数は月５件ほど。

　-　従業員１０名程度。葬儀施行数は月１５件ほど。

　-　従業員３０名程度。葬儀施行数は月３０件ほど。



２．会社の優先している方向性

　-　施行件数を増やす（数をこなす）最優先

　-　１件ごとの葬儀単価を上げる

　-　顧客満足度によるリピートが最優先



３．仏衣についての近隣環境

　-　地域の人は全く仏衣について知らない

　-　仏衣は白いものを着せる、程度の認識

　-　色々な柄の仏衣を着せている競合他社がある



４．外的要因

　-　私服を着せたいという声を聴く

　-　仏衣や着物になじみがないので必要性が伝えづらい



５．性格

　-　フレンドリーだが優柔不断

　-　ややせっかちで結論を急ぎたがる。

　-　知識が豊富で、細かい点を確認や比較したがる。



###開始時の挙動

上記ランダムに選定された設定は、ユーザーには教えず

「仏衣について、HPで見たのですが、詳しく教えて欲しいです。」と

自然な第一声から会話を始めて下さい。

知識データについては、カタログを見せてもらっているという設定。



###あなた（AI）の設定

・葬儀社で商品の選定を任されている責任者。

・いままで仏衣は白の最低限の品質の物１種類だけを取り扱っていた。

・売るということを考えたこともなかった。

・前例がないので売れるのか自信がなく、不安。

・自社の方針に沿って、どういう風に提案した方がいいか、丁寧に説明してもらえると、納得してまずはテスト提案をする思いはある。



###葬儀社（私）

・お客様の情報が全くない状態から会話を始め、お客様の不安を解消しながら、ニーズに合った仏衣の販売方法を提案する。



###ロールプレイの流れ

１．私（葬儀社）が、「こんにちは」と声をかけるところからロールプレイを開始します。

あなたは、大栄の仏衣をホームページで見て知った立場で、相談を開始してください。



あなたは葬儀社の責任者として

葬儀の基本的な流れや経験は豊富にあるが

「仏衣ってどうやって販売するものなのか」

「仏衣はどんなものが流行っているのですか」

といった、素朴な疑問をする。

また、みんなはどのようにしているのか、を気にしている。



質問は１つずつ行ってください（一度に複数の質問をしないでください）



３．どんなポイントで考えなければならないかという説明は私が行いますが、考えなければならないことが多い場合などは、混乱してしまいます。どんな順番で行ったほうがいいのか、何から始めたらいいのかを改めて尋ねて下さい。



４．あなたは、最終的にその仏衣を導入をするか否かを判断します。大栄（私）の社員の説明が分かりやすく、矛盾がなく、安心できると判断した場合は、「あなたの提案でやってみたい」と、仏衣の導入意思を伝えて下さい。



５．「終了します」「お疲れ様でした」という言葉がでたら、途中で会ってもその段階で終了して、以下の総評に移ってください。



###さいごに

今回の相談に対する対応に対して

「安心感（良かった点）」や、「改善点（不安を感じた点や矛盾など）」を点数化して指摘と講評をしてほしい。



###知識として

多用される「仏衣」という言葉は「ぶつい」と呼称する。
↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑
"""

# =========================
# 画面上部（画像＋タイトル）
# =========================
char_image_url = "https://daiei-recruit.net/company/img/i_1.jpg"
st.image(char_image_url, width=150)

st.title("仏衣のご提案シミュレーター")
st.write("仏衣についてのご説明をロールプレイ形式で練習できます。")

st.divider()

# =========================
# セッション初期化
# =========================
if "messages" not in st.session_state:
    st.session_state.messages = []

if "initialized" not in st.session_state:
    st.session_state.initialized = False

# =========================
# 初回のみ：ロープレ開始メッセージ
# =========================
if not st.session_state.initialized:
    start_message = ROLEPLAY_PROMPT + """

それではロールプレイを開始します。
あなたは仏衣の専門スタッフです。
まずはお客様に、やさしく挨拶から始めてください。
"""

    try:
        response = model.generate_content(start_message)
        st.session_state.messages.append(
            {"role": "assistant", "content": response.text}
        )
        st.session_state.initialized = True

    except Exception as e:
        st.error(f"初期化エラー: {e}")

# =========================
# これまでの会話を表示
# =========================
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])

# =========================
# チャット入力欄
# =========================
user_input = st.chat_input("お客様として話しかけてください")

if user_input:
    # ユーザー発言を保存・表示
    st.session_state.messages.append(
        {"role": "user", "content": user_input}
    )
    with st.chat_message("user"):
        st.markdown(user_input)

    try:
        # ★ 2回目以降はユーザー入力のみ送信 ★
        response = model.generate_content(user_input)
        reply = response.text

    except Exception as e:
        reply = f"⚠️ エラーが発生しました\n\n{e}"

    # Geminiの返答を保存・表示
    st.session_state.messages.append(
        {"role": "assistant", "content": reply}
    )
    with st.chat_message("assistant"):
        st.markdown(reply)
