import streamlit as st
import google.generativeai as genai

# =========================
# ãƒšãƒ¼ã‚¸è¨­å®š
# =========================
st.set_page_config(
    page_title="ä»è¡£ ææ¡ˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AI",
    page_icon="ğŸ•Šï¸",
    layout="centered"
)

# =========================
# ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–
# =========================
if "started" not in st.session_state:
    st.session_state.started = False

if "ended" not in st.session_state:
    st.session_state.ended = False

# =========================
# ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜
# =========================
st.image(
    "https://daiei-recruit.net/company/img/i_1.jpg",
    width=180
)

st.title("ğŸ•Šï¸ ä»è¡£ ææ¡ˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AI")
st.subheader("ã€œ è‘¬å„€ç¤¾å‘ã‘ ä»è¡£ææ¡ˆã®å–¶æ¥­ç·´ç¿’ãƒ„ãƒ¼ãƒ« ã€œ")

st.markdown("""
ã‚ãªãŸã¯ **ä»è¡£ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆå¤§æ „ï¼‰ã®å–¶æ¥­ãƒãƒ³**ã€‚  
AIã¯ **è‘¬å„€ç¤¾ã®è²¬ä»»è€…** ã¨ã—ã¦å¯¾å¿œã—ã¾ã™ã€‚

â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã§é–‹å§‹  
â–¶ é€”ä¸­çµ‚äº†ã™ã‚‹ã¨ã€ãã®æ™‚ç‚¹ã§ç·è©•ãŒå‡ºã¾ã™  
â–¶ ä½•åº¦ã§ã‚‚ã‚„ã‚Šç›´ã—å¯èƒ½
""")

st.divider()

# =========================
# Gemini API
# =========================
genai.configure(
    api_key=st.secrets["GEMINI_API_KEY"]
)

model = genai.GenerativeModel(
    model_name="gemini-2.0-flash",
    system_instruction="""
ã‚ãªãŸã¯ãƒªã‚¢ãƒ«ãªå•†è«‡ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤AIã§ã™ã€‚

ãƒ»AIã§ã‚ã‚‹ã“ã¨ã¯çµ¶å¯¾ã«æ˜ã‹ã•ãªã„
ãƒ»æ¯å›åå¿œãƒ»æ€è€ƒãƒ»è«–ç‚¹ã«æºã‚‰ãã‚’æŒãŸã›ã‚‹
ãƒ»è³ªå•ã¯å¿…ãš1ã¤ãšã¤è¡Œã†
ãƒ»æœ€çµ‚çš„ã«å°å…¥åˆ¤æ–­ã¨è¬›è©•ã‚’è¡Œã†
"""
)

# =========================
# ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤é•·æ–‡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
# =========================
ROLEPLAY_PROMPT = """
ã‚ãªãŸã¯ã€å¤§æ „ï¼ˆã ã„ãˆã„ï¼‰ã®ä»è¡£ã«èˆˆå‘³ã‚’æŒã¤è‘¬å„€ç¤¾ã®è²¬ä»»è€…ã€‘ã§ã™ã€‚
ç§ã¯ã€å¤§æ „ã®ä»è¡£ã‚’ææ¡ˆã™ã‚‹å–¶æ¥­ãƒãƒ³ã€‘ã§ã™ã€‚

ä»¥ä¸‹ã‚’å†…éƒ¨ã§ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ã€ãã®è¨­å®šã«ãªã‚Šãã£ã¦ãã ã•ã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯æ•™ãˆãªã„ï¼‰ã€‚

â–  è‘¬å„€ç¤¾ã®è¦æ¨¡
ãƒ»å®¶æ—çµŒå–¶ï¼ˆæœˆ5ä»¶ï¼‰
ãƒ»å¾“æ¥­å“¡10åï¼ˆæœˆ15ä»¶ï¼‰
ãƒ»å¾“æ¥­å“¡30åï¼ˆæœˆ30ä»¶ï¼‰

â–  ä¼šç¤¾ã®æ–¹é‡
ãƒ»ä»¶æ•°é‡è¦–
ãƒ»å˜ä¾¡é‡è¦–
ãƒ»é¡§å®¢æº€è¶³é‡è¦–

â–  ä»è¡£ã®åœ°åŸŸèªè­˜
ãƒ»ã»ã¼çŸ¥ã‚‰ã‚Œã¦ã„ãªã„
ãƒ»ç™½è£…æŸã®èªè­˜ã®ã¿
ãƒ»æŸ„ç‰©ã‚’æ‰±ã†ç«¶åˆã‚ã‚Š

â–  ç¾å ´ã®å£°
ãƒ»ç§æœã‚’ç€ã›ãŸã„ã¨ã„ã†è¦æœ›
ãƒ»ä»è¡£ã®å¿…è¦æ€§ãŒä¼ãˆã¥ã‚‰ã„

â–  æ€§æ ¼
ãƒ»å„ªæŸ”æ–­
ãƒ»ã›ã£ã‹ã¡
ãƒ»çŸ¥è­˜è±Šå¯Œã§æ¯”è¼ƒé‡è¦–

ã€é–‹å§‹æ™‚ã€‘
ã‚ãªãŸã‹ã‚‰è‡ªç„¶ãªç¬¬ä¸€å£°ã§ä¼šè©±ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚
ä¾‹ï¼š
ã€Œä»è¡£ã«ã¤ã„ã¦ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã§è¦‹ãŸã®ã§ã™ãŒã€è©³ã—ãæ•™ãˆã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿã€

ã€ãƒ«ãƒ¼ãƒ«ã€‘
ãƒ»è³ªå•ã¯å¿…ãš1ã¤ãšã¤
ãƒ»æ··ä¹±ã—ãŸã‚‰é †åºã‚’èãè¿”ã™
ãƒ»ç´å¾—ã—ãŸå ´åˆã®ã¿å°å…¥æ„æ€ã‚’ç¤ºã™

ã€çµ‚äº†æ¡ä»¶ã€‘
ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã§ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤çµ‚äº†ã¨ã™ã‚‹
ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œçµ‚äº†ã—ã¾ã™ã€ã€ŒãŠç–²ã‚Œæ§˜ã§ã—ãŸã€ã¨è¨€ã£ãŸå ´åˆ
ãƒ»é€”ä¸­çµ‚äº†ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸå ´åˆ

ã€çµ‚äº†å¾Œã€‘
å®‰å¿ƒæ„Ÿãƒ»èª¬æ˜ã®åˆ†ã‹ã‚Šã‚„ã™ã•ãƒ»æ”¹å–„ç‚¹ã‚’
ç‚¹æ•°ä»˜ãã§è¬›è©•ã—ã¦ãã ã•ã„ã€‚
"""

# =========================
# æ“ä½œãƒœã‚¿ãƒ³
# =========================
col1, col2, col3 = st.columns(3)

with col1:
    if not st.session_state.started:
        if st.button("â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ"):
            st.session_state.started = True
            st.session_state.ended = False
            st.session_state.chat = model.start_chat()
            st.session_state.chat.send_message(ROLEPLAY_PROMPT)
            st.rerun()

with col2:
    if st.session_state.started:
        if st.button("ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™"):
            st.session_state.started = False
            st.session_state.ended = False
            st.session_state.pop("chat", None)
            st.rerun()

with col3:
    if st.session_state.started and not st.session_state.ended:
        if st.button("â›” çµ‚äº†ï¼ˆä¸­æ–­ï¼‰"):
            st.session_state.ended = True
            summary_prompt = """
ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã‚’é€”ä¸­ã§çµ‚äº†ã—ã¾ã™ã€‚
ã“ã‚Œã¾ã§ã®ã‚„ã‚Šå–ã‚Šã‚’è¸ã¾ãˆã¦ã€
è‰¯ã‹ã£ãŸç‚¹ãƒ»æ”¹å–„ç‚¹ãƒ»ç·åˆè©•ä¾¡ã‚’ç‚¹æ•°ä»˜ãã§è¬›è©•ã—ã¦ãã ã•ã„ã€‚
"""
            response = st.session_state.chat.send_message(summary_prompt)
            st.session_state.summary = response.text

# =========================
# ãƒãƒ£ãƒƒãƒˆè¡¨ç¤º
# =========================
if st.session_state.started and not st.session_state.ended:
    st.subheader("ğŸ’¬ ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ä¸­")

    user_input = st.chat_input("ä¾‹ï¼šã“ã‚“ã«ã¡ã¯")

    if user_input:
        with st.chat_message("user"):
            st.write(user_input)

        response = st.session_state.chat.send_message(user_input)

        with st.chat_message("assistant"):
            st.write(response.text)

# =========================
# ç·è©•è¡¨ç¤º
# =========================
if st.session_state.ended:
    st.subheader("ğŸ“ ç·è©•")

    st.write(st.session_state.summary)
