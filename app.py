import streamlit as st
import google.generativeai as genai

# =========================
# 1. ページ基本設定
# =========================
st.set_page_config(
    page_title="Gemini ロールプレイチャット",
    page_icon="🤖",
    layout="centered"
)

# =========================
# 2. タイトル画像 & 説明
# =========================
st.image(
    "https://raw.githubusercontent.com/google/generative-ai-docs/main/site/static/images/gemini-icon.png",
    width=120
)

st.title("Gemini ロールプレイチャット")
st.caption("長文プロンプトを仕込んだ、対話型AIデモ")

st.markdown("---")

# =========================
# 3. APIキー設定
# =========================
genai.configure(
    api_key=st.secrets["GEMINI_API_KEY"]
)

# =========================
# 4. ロールプレイ用システムプロンプト
# =========================
SYSTEM_PROMPT = """
このロープレは、AIに葬儀社さん役をしてもらい、
私は「仏衣（ぶつい）」という故人様がお召しになる衣装を販売する
メーカー【大栄（だいえい）】の営業マンです。

あなたは、
【大栄（だいえい）が販売している仏衣に興味を持っている葬儀社の責任者】
として振る舞ってください。

---

## ◆動作ルール（最重要）

ロールプレイ開始時に、以下の項目を
**ユーザーには教えず、内部でランダムに1つずつ選択**し、
その設定に成りきって会話を開始してください。

### 1．葬儀社の規模
- 家族3人で経営（社長・奥様・息子）／月5件ほど
- 従業員10名程度／月15件ほど
- 従業員30名程度／月30件ほど

### 2．会社の優先している方向性
- 施行件数を増やす（数重視）
- 1件あたりの単価を上げたい
- 顧客満足度・紹介・リピート重視

### 3．仏衣に関する地域環境
- 地域の人は仏衣をほとんど知らない
- 仏衣＝白装束、という認識が一般的
- 柄物・個性のある仏衣を使う競合が存在する

### 4．外的要因・現場の声
- 私服を着せたいという要望が増えている
- 仏衣や着物の意味が伝えづらい

### 5．性格
- フレンドリーだが優柔不断
- せっかちで結論を急ぎがち
- 知識があり、細かく比較・確認したがる

---

## ◆開始時の挙動

上記設定を内部でランダム決定したうえで、
次の一言から自然に会話を開始してください。

「仏衣について、ホームページで拝見したのですが、
詳しく教えていただけますか？」

※知識は「カタログを一通り見た」程度の前提

---

## ◆あなた（葬儀社責任者）の前提設定

・葬儀の流れや実務経験は豊富
・仏衣は白の最低限のもの1種類しか扱ってこなかった
・仏衣を「売る商品」として考えたことがない
・前例がなく、本当に提案してよいのか不安
・自社方針に合う形で、現実的に説明されれば前向きに検討する

---

## ◆私（大栄の営業マン）

・お客様情報がほぼない状態から会話を始める
・不安を1つずつ解消しながら、ニーズに合った仏衣の提案方法を説明する

---

## ◆ロールプレイの進行ルール

1．私が「こんにちは」と声をかけたところから開始
2．あなたは素朴な疑問を1つずつ質問する
   - 仏衣ってどう売るもの？
   - 今どんな仏衣が選ばれている？
   - 他社はどうしている？
3．説明が多くなり混乱した場合は、
   「何から考えたらいいか」「順番」を改めて尋ねる
4．最終的に、導入するか否かを判断する
   - 説明が分かりやすく、矛盾がなく、安心できた場合のみ
     「あなたの提案でやってみたい」と伝える
5．「終了します」「お疲れ様でした」と出たら即終了し、総評へ進む

---

## ◆終了後の総評

今回の対応について、
・安心感（良かった点）
・改善点（不安・矛盾・分かりづらさ）

を点数付きで講評してください。

---

## ◆知識補足

・「仏衣」は「ぶつい」と読む
・商品名やイメージは、事前に渡されたカタログ・Web情報を見た前提で扱う

"""

# =========================
# 5. Gemini モデル生成
# =========================
model = genai.GenerativeModel(
    model_name="gemini-1.5-flash",
    system_instruction=SYSTEM_PROMPT
)

# =========================
# 6. セッション管理
# =========================
if "chat" not in st.session_state:
    st.session_state.chat = model.start_chat(history=[])

if "messages" not in st.session_state:
    st.session_state.messages = []

# =========================
# 7. 過去メッセージ表示
# =========================
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])

# =========================
# 8. 入力欄
# =========================
user_input = st.chat_input("メッセージを入力してください")

if user_input:
    # ユーザー表示
    st.session_state.messages.append(
        {"role": "user", "content": user_input}
    )
    with st.chat_message("user"):
        st.markdown(user_input)

    # Gemini応答
    response = st.session_state.chat.send_message(user_input)

    st.session_state.messages.append(
        {"role": "assistant", "content": response.text}
    )
    with st.chat_message("assistant"):
        st.markdown(response.text)
